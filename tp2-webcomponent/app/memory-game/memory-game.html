<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./card-component/card-component.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<dom-module id="memory-game">
    <link rel="import" type="css" href="style.css">
    <template>
        <div id="score">
            <label>Nombre de coup : </label> <span>{{score}}</span>
        </div>
        <paper-toast id="toast" text="{{textResult}}" duration="1000000">
            <div on-tap="retry">Rejouer</div>
        </paper-toast>

        <div id="game"></div>
    </template>

    <script>
        Polymer({
            is : "memory-game",
            properties : {
                numberoffamily : {
                    type : Number,
                    value : 0
                },
                score : {
                    type : Number,
                    value : 0
                }
            },
            //Ecoute l'event 'card-clicked' des composants enfants
            listeners: {
                "card-clicked" : "check"
            },
            currentId1 : "", // id de la première carte retournée en cours
            currentFamily1 : "", // famille de la première carte retournée en cours
            currentId2 : "", // id de la deuxième carte retournée en cours
            currentFamily2 : "", // famille de la deuxième carte retournée en cours
            flipCount : 0, // nombre de carte retournée
            score : 0, // nombre de coup joué
            textResult :"", // texte affiché à l'affichage du paper-toast
            //Evènement lorsque le composant est prêt
            ready: function() {
                var values = [];
                //Génération aléatoires des couleurs des cartes
                for (i = 0; i < this.numberoffamily; i++) {
                    var color = this.randomColor();
                    values.push({family : i, color : color});
                    values.push({family : i, color : color});
                }

                //On mélange le tableau
                for (var i = values.length-1; i >=0; i--) {
                    var randomIndex = Math.floor(Math.random()*(i+1));
                    var itemAtIndex = values[randomIndex];
                    values[randomIndex] = values[i];
                    values[i] = itemAtIndex;
                }
                //création des carte et ajout au shadow DOM
                values.forEach(function(value){
                    var card = new CardComponent(value.family, value.color);
                    Polymer.dom(this.root).querySelector('#game').appendChild(card);
                },this);
            },
            //Fonction pour générer une couleur aléatoire
            randomColor : function () {
                var letters = '0123456789ABCDEF'.split('');
                var color = '#';
                for (var i = 0; i < 6; i++ ) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            },
            //Fonction pour lancer une vérification de l'égalité des cartes
            check : function (event,detail) {
                this.score = this.score + 1;
                // Si le score modulo 2 donne 0 c'est que l'on doit faire un check sur l'ensemble des cartes
                if(this.score % 2 == 0){
                    this.currentId2 = detail.id;
                    this.currentFamily2 = detail.family;
                    var _this = this;
                    //On bloque tout évènement des cartes pour avoir le temps de retourner les cartes si elles ne
                    //sont pas identiques
                    this.disableCard(true);
                    setTimeout(function(){
                        //Si elle ne sont pas identique
                        if(_this.currentFamily1 != _this.currentFamily2){
                            //On demande au deux cartes retournée précédemment de se cacher
                            var dataSend = { id : _this.currentId1 };
                            _this.fire("iron-signal", {name: 'flip-back', data: dataSend} );
                            dataSend ={ id : _this.currentId2 };
                            _this.fire("iron-signal", {name: 'flip-back', data: dataSend} );
                        } else {
                            _this.flipCount = _this.flipCount +2;
                            //Si toutes les cartes sont retournées on affiche le bandeau de fin du jeu
                            if(_this.flipCount == _this.numberoffamily * 2) {
                                _this.textResult = "Vous avez réussi en "+_this.score+" coup(s).";
                                Polymer.dom(_this.root).querySelector('#toast').show();
                            }
                        }
                        //On réinitialise les variables
                        _this.disableCard(false);
                    }, 1000);
                } else {
                    // Stockage de l'id de la carte courante pour la comparer avec la prochaine carte retounée
                    this.currentId1 = detail.id;
                    this.currentFamily1 = detail.family;
                }
            },
            //fonction pour recommencer le jeu et repartir de 0
            retry : function(){
                this.fire("flip");
                this.score = 0;
                this.flipCount = 0;
                var game =Polymer.dom(this.root).querySelector('#game');
                while(game.childElementCount > 0) {
                    game.removeChild(game.children[0]);
                }
                this.ready();
                Polymer.dom(this.root).querySelector('#toast').hide();
            },
            //fonction pour bloquer les évènements sur les cartes
            disableCard : function (bool){
                var game = Polymer.dom(this.root).querySelector('#game');
                for(var i = 0 ; i<game.childElementCount ; i++){
                    game.children[i].disabled=bool;
                }
            }

        });
    </script>
</dom-module>